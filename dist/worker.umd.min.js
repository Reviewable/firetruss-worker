((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Fireworker=t()})(this,function(){let s=[],a={};self.localStorage=new class{constructor(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)}init(e){this._initialized||(this._items=e,this._initialized=!0)}_update(e){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(e)}flushPending(){this._pendingItems.length&&(s.length?(s[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]):setTimeout(this._flushPending,200))}get length(){return this._items.length}key(e){return this._items[e].key}getItem(e){for(var t of this._items)if(t.key===e)return t.value;return null}setItem(e,t){let s;for(var a of this._items)if(a.key===e){(s=a).value=t;break}s||(s={key:e,value:t},this._items.push(s)),this._update(s)}removeItem(t){for(let e=0;e<this._items.length;e++)if(this._items[e].key===t){this._items.splice(e,1),this._update({key:t,value:null});break}}clear(){for(var e in this._items)this._update({key:e.key,value:null});this._items=[]}};class c{constructor(){this._root=null}set(e){this._root=e}diff(e,t){var s={},a="/"===t?[""]:t.split("/");return this._diffRecursively(this._root,e,a,s)&&(this._root=e,s[t]=e),s}_diffRecursively(t,s,a,r){if(void 0===s&&(s=null),null===(t=void 0===t?null:t))return null!==s;if(!(t instanceof Object&&s instanceof Object))return s!==t;{let e=!0;var i,n,l,o=[];for(i in s)Object.hasOwn(s,i)&&(this._diffRecursively(t[i],s[i],a.concat(i),r)?o.push(i):e=!1);if(e)return!0;for(n in t)Object.hasOwn(t,n)&&!Object.hasOwn(s,n)&&(r[a.concat(n).join("/")]=null,delete t[n]);for(l of o)r[a.concat(l).join("/")]=s[l],t[l]=s[l]}}}class r{constructor(e){this._port=e,this._lastWriteSerial=0,this._app=void 0,this._cachedAuth=void 0,this._cachedDatabase=void 0,this._lastJsonUser=void 0,this._configError=r._staticConfigError,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),e.onmessage=this._receive.bind(this)}get _auth(){if(this._cachedAuth)return this._cachedAuth;if(this._app)return this._cachedAuth=this._app.auth();throw new Error("Must provide Firebase configuration data first")}get _database(){if(!this._cachedDatabase){if(!this._app)throw new Error("Must provide Firebase configuration data first");r._databaseWrapperCallback?this._cachedDatabase=r._databaseWrapperCallback(this._app.database()):this._cachedDatabase=this._app.database()}return this._cachedDatabase}init({storage:e,config:t}){if(e&&self.localStorage.init(e),t)try{this._app=a[t.databaseURL],this._app||(this._app=a[t.databaseURL]=firebase.initializeApp(t,t.databaseURL),t.apiKey&&t.apiKey.length<20&&(this._app.database().INTERNAL.forceWebSockets(),this._app.auth().useEmulator(t.databaseURL,{disableWarnings:!0}))),this._app.database(),this._app.auth(),this._configError=r._staticConfigError}catch(e){throw this._configError=e}else if(this._configError)throw this._configError;return{exposedFunctionNames:Object.keys(r._exposed),version:"dev",firebaseSdkVersion:firebase.SDK_VERSION}}destroy(){for(var e in this._callbacks){e=this._callbacks[e];e.cancel&&e.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var t=s.indexOf(this);0<=t&&(s[t]=null)}enableFirebaseLogging({value:e}){firebase.database.enableLogging(e)}ping(){}bounceConnection(){this._database.goOffline(),this._database.goOnline()}_receive(e){r._firstMessageReceived=!0;for(var t of e.data)this._receiveMessage(t)}_receiveMessage(t){let s;try{var e=this[t.msg];if("function"!=typeof e)throw new Error("Unknown message: "+t.msg);t.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,t.writeSerial)),s=Promise.resolve(e.call(this,t))}catch(e){e.immediateFailure=!0,s=Promise.reject(e)}t.oneWay||s.then(e=>{this._send({msg:"resolve",id:t.id,result:e})},e=>{this._send({msg:"reject",id:t.id,error:i(e)})})}_send(e){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(e)}_flushMessageQueue(){try{this._port.postMessage(this._messages)}catch{for(var t of this._messages)try{this._port.postMessage([t])}catch(e){var s={name:e.name,message:e.message};if(t.error&&(s.cause=t.error.name+": "+t.error.message),t.result)try{s.cause="result: "+JSON.stringify(t.result)}catch(e){s.cause=`result JSON error: ${e.name}: `+e.message}this._port.postMessage([{msg:"crash",error:s}])}}this._messages=[]}call({name:e,args:t}){try{return Promise.resolve(r._exposed[e].apply(null,t))}catch(e){return Promise.reject(e)}}authWithCustomToken({authToken:e}){return this._auth.signInWithCustomToken(e).then(e=>n(e.user))}authAnonymously({}){return this._auth.signInAnonymously().then(e=>n(e.user))}unauth({}){return this._auth.signOut().catch(e=>{if(null!==this._auth.currentUser)return Promise.reject(e);for(var t in this._callbacks)Object.hasOwn(this._callbacks,t)&&(t=this._callbacks[t]).auth&&t(null)})}onAuth({callbackId:e}){e=this._callbacks[e]=this._onAuthCallback.bind(this,e);e.auth=!0,e.cancel=this._auth.onIdTokenChanged(e)}_onAuthCallback(t,e){n(e).then(e=>{!function t(s,a){if(s===a)return!0;if(null===s&&null===a||void 0===s&&void 0===a)return!0;if(null===s||null===a||void 0===s||void 0===a)return!1;if("object"!=typeof s||"object"!=typeof a)return!1;for(var e in s){if(!Object.hasOwn(s,e)||!Object.hasOwn(a,e))return!1;if(!t(s[e],a[e]))return!1}for(var r in a)if(!Object.hasOwn(s,r)||!Object.hasOwn(a,r))return!1;if(Array.isArray(s)||Array.isArray(a)){if(!Array.isArray(s)||!Array.isArray(a))return!1;if(s.length!==a.length)return!1;for(let e=0;e<s.length;e++)if(!t(s[e],a[e]))return!1}return!0}(this._lastJsonUser,e)&&(this._lastJsonUser=e,this._send({msg:"callback",id:t,args:[e]}))})}set({url:e,value:t}){return this._createRef(e).set(t)}update({url:e,value:t}){return this._createRef(e).update(t)}once({url:e}){return this._createRef(e).once("value").then(e=>this._snapshotToJson(e))}on({listenerKey:e,url:t,spec:s,eventType:a,callbackId:r,options:i}){(i=i||{}).sync&&(i.branch=new c),i.cancel=this.off.bind(this,{listenerKey:e,url:t,spec:s,eventType:a,callbackId:r});var n=this._callbacks[r]=this._onSnapshotCallback.bind(this,r,i),e=(n.listenerKey=e,n.eventType=a,n.cancel=i.cancel,this._onCancelCallback.bind(this,r));this._createRef(t,s).on(a,n,e)}off({listenerKey:e,url:t,spec:s,eventType:a,callbackId:r}){let i;if(r)i=this._callbacks[r],delete this._callbacks[r];else for(var n of Object.keys(this._callbacks)){var l;Object.hasOwn(this._callbacks,n)&&((l=this._callbacks[n]).listenerKey!==e||a&&l.eventType!==a||delete this._callbacks[n])}this._createRef(t,s).off(a,i)}_onSnapshotCallback(t,s,a){if(s.sync&&s.rest){var r=decodeURIComponent(a.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,""));let e;try{e=h(a.val())}catch(e){return s.cancel(),void this._onCancelCallback(t,e)}var i,n=s.branch.diff(e,r);for(i in n)Object.hasOwn(n,i)&&this._send({msg:"callback",id:t,args:[null,{path:i,value:n[i],writeSerial:this._lastWriteSerial}]})}else try{var e=this._snapshotToJson(a);s.sync&&s.branch.set(e.value),this._send({msg:"callback",id:t,args:[null,e]}),s.rest=!0}catch(e){s.cancel(),this._onCancelCallback(t,e)}}_onCancelCallback(e,t){delete this._callbacks[e],this._send({msg:"callback",id:e,args:[i(t)]})}transaction({url:e,oldValue:s,relativeUpdates:i}){let r=decodeURIComponent(e.replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),t=this._createRef(e),n=new c,l,o;return t.transaction(e=>{if(o=void 0,e=h(e),(l=!function e(t,s){if(t===s)return!0;if(null==t&&null==s)return!0;if(null===t||null===s)return!1;if("object"!=typeof t||"object"!=typeof s)return!1;for(var a in t){if(!Object.hasOwn(t,a)||!Object.hasOwn(s,a))return!1;if(!e(t[a],s[a]))return!1}for(var r in s)if(!Object.hasOwn(t,r)||!Object.hasOwn(s,r))return!1;return!0}(e,s))&&(e=s),i)for(var t in i)if(Object.hasOwn(i,t))if(t){var a=t.split("/");let s=e=null==e?{}:e;for(let t=0;t<a.length-1;t++){var r=a[t];let e=s[r];null==e&&(e=s[r]={}),s=e}s[a[a.length-1]]=i[t]}else e=i[t];if(n.set(e),!l)return o=e}).then(e=>{var t,s=[],a=n.diff(h(e.snapshot.val()),r);for(t in a)Object.hasOwn(a,t)&&s.push({path:t,value:a[t],writeSerial:e.writeSerial||this._lastWriteSerial});return{committed:!l,snapshots:s}},e=>"set"===e.message||"disconnect"===e.message?t.once("value").then(e=>({committed:!1,snapshots:[e],writeSerial:this._lastWriteSerial})):(e.committedValue=o,Promise.reject(e)))}_snapshotToJson(e){return{path:decodeURIComponent(e.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),value:h(e.val()),writeSerial:this._lastWriteSerial}}onDisconnect({url:e,method:t,value:s}){return this._createRef(e).onDisconnect()[t](s)}_createRef(t,s){if(!this._app)throw new Error("Must provide Firebase configuration data first");try{let e=this._database.refFromURL(t);if(s){switch(s.by){case"$key":e=e.orderByKey();break;case"$value":e=e.orderByValue();break;default:e=e.orderByChild(s.by)}void 0!==s.at?e=e.equalTo(s.at):void 0!==s.from?e=e.startAt(s.from):void 0!==s.to&&(e=e.endAt(s.to)),void 0!==s.first?e=e.limitToFirst(s.first):void 0!==s.last&&(e=e.limitToLast(s.last))}return e}catch(e){throw e.extra={url:t,spec:s},e}}static expose(e,t){(t=t||e.name)||r._signalStaticConfigError(new Error("Cannot expose a function with no name: "+e)),Object.hasOwn(r._exposed,t)&&r._signalStaticConfigError(new Error(`Function ${t}() already exposed`)),r._firstMessageReceived&&r._signalStaticConfigError(new Error("Too late to expose function, worker in use")),r._exposed[t]=e}static setDatabaseWrapperCallback(e){r._databaseWrapperCallback&&r._signalStaticConfigError(new Error("Database wrapper callback already set")),r._firstMessageReceived&&r._signalStaticConfigError(new Error("Too late to set database wrapper callback, worker in use")),r._databaseWrapperCallback=e}static _signalStaticConfigError(e){r._staticConfigError||(r._staticConfigError=e);for(var t of s)t&&!t._configError&&(t._configError=e);throw e}}function i(e){var t,s={name:e.name,message:e.message};for(t of Object.getOwnPropertyNames(e)){var a=typeof e[t];"string"!=a&&"number"!=a&&"boolean"!=a||(s[t]=e[t])}return s}function h(t){if(Array.isArray(t)){var s={};for(let e=0;e<t.length;e++){var a=t[e];null!=a&&(s[e]=h(a))}return s}if(t instanceof Object)for(var e in t)Object.hasOwn(t,e)&&(t[e]=h(t[e]));return t}function n(e){if(!e)return Promise.resolve(e);let t=e.toJSON();return delete t.stsTokenManager,e.getIdTokenResult().then(e=>(delete e.claims.exp,delete e.claims.iat,t.claims=e.claims,t))}return r._exposed={},r._firstMessageReceived=!1,r._databaseWrapperCallback=void 0,r._staticConfigError=void 0,self.window=self,"undefined"==typeof onconnect?s.push(new r(self)):self.onconnect=function(e){s.push(new r(e.ports[0]))},self.localStorage.flushPending(),r});
//# sourceMappingURL=worker.umd.min.js.map