!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Fireworker=b()}(this,function(){"use strict";function a(){if(!j){var a,b=console.log;console.log=function(){var c=Array.prototype.join.call(arguments," ");if(!/^(FIREBASE: \n?)+/.test(c))return b.apply(console,arguments);if(c=c.replace(/^(FIREBASE: \n?)+/,"").replace(/^\s+([^.]*):(?:\.(read|write|validate):)?.*/g,function(a,b,c){return c=c||"read"," "+c+" "+b}),/^\s+/.test(c)){var d=c.match(/^\s+=> (true|false)/);d?(g[a]=("true"===d[1]?" ✓":" ✗")+g[a],a=void 0):(a===g.length-1&&g.pop(),g.push(c),a=g.length-1)}else/^\d+:\d+: /.test(c)?g.push("   "+c):(a===g.length-1&&g.pop(),g.push(c),a=void 0)},j=!0}}function b(a){for(var b={name:a.name},c=Object.getOwnPropertyNames(a),d=0,e=c;d<e.length;d+=1){var f=e[d];b[f]=a[f]}return b}function c(a,b,c){try{var d=new Firebase(a,c);if(b){switch(b.by){case"$key":d=d.orderByKey();break;case"$value":d=d.orderByValue();break;default:d=d.orderByChild(b.by)}b.at?d=d.equalTo(b.at):b.from?d=d.startAt(b.from):b.to&&(d=d.endAt(b.to)),b.first?d=d.limitToFirst(b.first):b.last&&(d=d.limitToLast(b.last))}return d}catch(d){throw d.extra={url:a,spec:b,context:c},d}}function d(a){if(Array.isArray(a)){for(var b={},c=0;c<a.length;c++){var e=a[c];void 0!==e&&null!==e&&(b[c]=d(e))}return b}if(a instanceof Object)for(var f in a)a.hasOwnProperty(f)&&(a[f]=d(a[f]));return a}function e(a,b){if(a===b)return!0;if(!(null!==a&&void 0!==a||null!==b&&void 0!==b))return!0;if(null===a||null===b)return!1;if("object"!=typeof a||"object"!=typeof b)return!1;for(var c in a){if(!a.hasOwnProperty(c)||!b.hasOwnProperty(c))return!1;if(!e(a[c],b[c]))return!1}for(var d in b)if(!a.hasOwnProperty(d)||!b.hasOwnProperty(d))return!1;return!0}function f(){"undefined"!=typeof onconnect?self.onconnect=function(a){h.push(new n(a.ports[0]))}:h.push(new n(self)),self.localStorage.flushPending()}var g,h=[],i=Promise.resolve(),j=!1,k=function(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)},l={length:{}};k.prototype.init=function(a){this._initialized||(this._items=a,this._initialized=!0)},k.prototype._update=function(a){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(a)},k.prototype.flushPending=function(){if(this._pendingItems.length){if(!h.length)return void setTimeout(this._flushPending,200);h[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]}},l.length.get=function(){return this._items.length},k.prototype.key=function(a){return this._items[a].key},k.prototype.getItem=function(a){for(var b=this,c=0,d=b._items;c<d.length;c+=1){var e=d[c];if(e.key===a)return e.value}return null},k.prototype.setItem=function(a,b){for(var c,d=this,e=0,f=d._items;e<f.length;e+=1){var g=f[e];if(g.key===a){c=g,g.value=b;break}}c||(c={key:a,value:b},this._items.push(c)),this._update(c)},k.prototype.removeItem=function(a){for(var b=this,c=0;c<this._items.length;c++)if(b._items[c].key===a){b._items.splice(c,1),b._update({key:a,value:null});break}},k.prototype.clear=function(){var a=this;for(var b in a._items)a._update({key:b.key,value:null});this._items=[]},Object.defineProperties(k.prototype,l),self.localStorage=new k;var m=function(){this._root=null};m.prototype.set=function(a){this._root=a},m.prototype.diff=function(a,b){var c={},d="/"===b?[""]:b.split("/");return this._diffRecursively(this._root,a,d,c)&&(this._root=a,c[b]=a),c},m.prototype._diffRecursively=function(a,b,c,d){var e=this;if(void 0===a&&(a=null),void 0===b&&(b=null),null===a)return null!==b;if(!(a instanceof Object&&b instanceof Object))return b!==a;var f=!0,g=[];for(var h in b)if(b.hasOwnProperty(h)){var i=e._diffRecursively(a[h],b[h],c.concat(h),d);i?g.push(h):f=!1}if(f)return!0;for(var j in a)a.hasOwnProperty(j)&&!b.hasOwnProperty(j)&&(d[c.concat(j).join("/")]=null,delete a[j]);for(var k=0,l=g;k<l.length;k+=1){var m=l[k];d[c.concat(m).join("/")]=b[m],a[m]=b[m]}};var n=function(a){this.ping(),this._port=a,this._lastWriteSerial=0,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),a.onmessage=this._receive.bind(this)};n.prototype.init=function(a){var b=a.storage,d=a.url;return b&&self.localStorage.init(b),d&&c(d),{exposedFunctionNames:Object.keys(n._exposed),version:"dev",firebaseSdkVersion:Firebase.SDK_VERSION}},n.prototype.destroy=function(){var a=this;for(var b in a._callbacks){var c=a._callbacks[b];c.cancel&&c.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var d=h.indexOf(this);d>=0&&(h[d]=null)},n.prototype.ping=function(){this.lastTouched=Date.now()},n.prototype.bounceConnection=function(){Firebase.goOffline(),Firebase.goOnline()},n.prototype._receive=function(a){var b=this;n._firstMessageReceived=!0,this.lastTouched=Date.now();for(var c=0,d=a.data;c<d.length;c+=1){var e=d[c];b._receiveMessage(e)}},n.prototype._receiveMessage=function(a){var c,d=this;try{var e=this[a.msg];if("function"!=typeof e)throw new Error("Unknown message: "+a.msg);a.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,a.writeSerial)),c=Promise.resolve(e.call(this,a))}catch(a){a.immediateFailure=!0,c=Promise.reject(a)}a.oneWay||c.then(function(b){d._send({msg:"resolve",id:a.id,result:b})},function(c){d._send({msg:"reject",id:a.id,error:b(c)})})},n.prototype._send=function(a){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(a)},n.prototype._flushMessageQueue=function(){this._port.postMessage(this._messages),this._messages=[]},n.prototype.call=function(a){var b=a.name,c=a.args;try{return Promise.resolve(n._exposed[b].apply(null,c))}catch(a){return Promise.reject(a)}},n.prototype.authWithCustomToken=function(a){var b=a.url,d=a.authToken,e=a.options;return c(b).authWithCustomToken(d,e)},n.prototype.unauth=function(a){return c(a.url).unauth()},n.prototype.onAuth=function(a){var b=a.url,d=a.callbackId,e=this._callbacks[d]=this._onAuthCallback.bind(this,d);e.cancel=this._offAuth.bind(this,b,e),c(b).onAuth(e)},n.prototype._offAuth=function(a,b){c(a).offAuth(b)},n.prototype._onAuthCallback=function(a,b){this._send({msg:"callback",id:a,args:[b]})},n.prototype.set=function(a){var b=a.url,d=a.value;return c(b).set(d)},n.prototype.update=function(a){var b=a.url,d=a.value;return c(b).update(d)},n.prototype.once=function(a){var b=this;return c(a.url).once("value").then(function(a){return b._snapshotToJson(a)})},n.prototype.on=function(a){var b=a.listenerKey,d=a.url,e=a.spec,f=a.eventType,g=a.callbackId,h=a.options;h=h||{},h.sync&&(h.branch=new m),h.cancel=this.off.bind(this,{listenerKey:b,url:d,spec:e,eventType:f,callbackId:g});var i=this._callbacks[g]=this._onSnapshotCallback.bind(this,g,h);i.listenerKey=b,i.eventType=f,i.cancel=h.cancel;var j=this._onCancelCallback.bind(this,g);c(d,e).on(f,i,j)},n.prototype.off=function(a){var b,d=this,e=a.listenerKey,f=a.url,g=a.spec,h=a.eventType,i=a.callbackId;if(i)b=this._callbacks[i],delete this._callbacks[i];else for(var j=0,k=Object.keys(d._callbacks);j<k.length;j+=1){var l=k[j];if(d._callbacks.hasOwnProperty(l)){var m=d._callbacks[l];m.listenerKey!==e||h&&m.eventType!==h||delete d._callbacks[l]}}c(f,g).off(h,b)},n.prototype._onSnapshotCallback=function(a,b,c){var e=this;if(b.sync&&b.rest){var f,g=decodeURIComponent(c.ref().toString().replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,""));try{f=d(c.val())}catch(c){return b.cancel(),void this._onCancelCallback(a,c)}var h=b.branch.diff(f,g);for(var i in h)h.hasOwnProperty(i)&&e._send({msg:"callback",id:a,args:[null,{path:i,value:h[i],writeSerial:e._lastWriteSerial}]})}else try{var j=this._snapshotToJson(c);b.sync&&b.branch.set(j.value),this._send({msg:"callback",id:a,args:[null,j]}),b.rest=!0}catch(c){b.cancel(),this._onCancelCallback(a,c)}},n.prototype._onCancelCallback=function(a,c){delete this._callbacks[a],this._send({msg:"callback",id:a,args:[b(c)]})},n.prototype.transaction=function(a){var b,f=this,g=a.url,h=a.oldValue,i=a.relativeUpdates,j=decodeURIComponent(g.replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,"")),k=c(g),l=new m;return k.transaction(function(a){if(a=d(a),b=!e(a,h),b&&(a=h),i)for(var c in i)if(i.hasOwnProperty(c))if(c){var f=c.split("/");void 0!==a&&null!==a||(a={});for(var g=a,j=0;j<f.length-1;j++){var k=f[j],m=g[k];void 0!==m&&null!==m||(m=g[k]={}),g=m}g[f[f.length-1]]=i[c]}else a=i[c];if(l.set(a),!b)return a}).catch(function(a){return"set"===a.message||"disconnect"===a.message?k.once("value").then(function(a){return{committed:!1,snapshots:[a],writeSerial:f._lastWriteSerial}}):Promise.reject(a)}).then(function(a){var c=[],e=l.diff(d(a.snapshot.val()),j);for(var g in e)e.hasOwnProperty(g)&&c.push({path:g,value:e[g],writeSerial:a.writeSerial||f._lastWriteSerial});return{committed:!b,snapshots:c}})},n.prototype._snapshotToJson=function(a){return{path:decodeURIComponent(a.ref().toString().replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,"")),value:d(a.val()),writeSerial:this._lastWriteSerial}},n.prototype.onDisconnect=function(a){var b=a.url,d=a.method,e=a.value;return c(b).onDisconnect()[d](e)},n.prototype.simulate=function(b){var d=b.token,e=b.method,f=b.url,h=b.spec,j=b.args;a();var k;return i=i.catch(function(){}).then(function(){return g=[],k=c(f,h,"permission_denied_simulator"),k.unauth(),k.authWithCustomToken(d,function(){},{remember:"none"})}).then(function(){return k[e].apply(k,j)}).then(function(){return null},function(a){var b=a.code||a.message;return b&&"permission_denied"===b.toLowerCase()?g.join("\n"):"Got a different error in simulation: "+a})},n.expose=function(a,b){if(b=b||a.name,!b)throw new Error("Cannot expose a function with no name: "+a);if(n._exposed.hasOwnProperty(b))throw new Error("Function "+b+"() already exposed");if(n._firstMessageReceived)throw new Error("Too late to expose function, worker in use");n._exposed[b]=a},n._exposed={},n._firstMessageReceived=!1;var o=Date.now();return setInterval(function(){var a=Date.now(),b=a-o-6e4;o=a,h.forEach(function(c){c&&(b>=1e3&&c.lastTouched<=a-b&&(c.lastTouched+=b),a-c.lastTouched>=18e4&&c.destroy())});for(var c;(c=h.indexOf(null))>=0;)h.splice(c,1)},6e4),self.window=self,f(),n});
//# sourceMappingURL=worker.umd.min.js.map