!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Fireworker=t()}(this,function(){"use strict";const r=[],s={};self.localStorage=new class{constructor(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)}init(e){this._initialized||(this._items=e,this._initialized=!0)}_update(e){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(e)}flushPending(){this._pendingItems.length&&(r.length?(r[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]):setTimeout(this._flushPending,200))}get length(){return this._items.length}key(e){return this._items[e].key}getItem(e){for(const t of this._items)if(t.key===e)return t.value;return null}setItem(e,t){let s;for(const r of this._items)if(r.key===e){(s=r).value=t;break}s||(s={key:e,value:t},this._items.push(s)),this._update(s)}removeItem(t){for(let e=0;e<this._items.length;e++)if(this._items[e].key===t){this._items.splice(e,1),this._update({key:t,value:null});break}}clear(){for(const e in this._items)this._update({key:e.key,value:null});this._items=[]}};class c{constructor(){this._root=null}set(e){this._root=e}diff(e,t){var s={},r="/"===t?[""]:t.split("/");return this._diffRecursively(this._root,e,r,s)&&(this._root=e,s[t]=e),s}_diffRecursively(t,s,r,a){if(void 0===s&&(s=null),null===(t=void 0===t?null:t))return null!==s;if(!(t instanceof Object&&s instanceof Object))return s!==t;{let e=!0;var i=[];for(const n in s)s.hasOwnProperty(n)&&(this._diffRecursively(t[n],s[n],r.concat(n),a)?i.push(n):e=!1);if(e)return!0;for(const o in t)t.hasOwnProperty(o)&&!s.hasOwnProperty(o)&&(a[r.concat(o).join("/")]=null,delete t[o]);for(const l of i)a[r.concat(l).join("/")]=s[l],t[l]=s[l]}}}class a{constructor(e){this._port=e,this._lastWriteSerial=0,this._app=void 0,this._cachedAuth=void 0,this._cachedDatabase=void 0,this._lastJsonUser=void 0,this._configError=a._staticConfigError,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),e.onmessage=this._receive.bind(this)}get _auth(){if(this._cachedAuth)return this._cachedAuth;if(this._app)return this._cachedAuth=this._app.auth();throw new Error("Must provide Firebase configuration data first")}get _database(){if(!this._cachedDatabase){if(!this._app)throw new Error("Must provide Firebase configuration data first");a._databaseWrapperCallback?this._cachedDatabase=a._databaseWrapperCallback(this._app.database()):this._cachedDatabase=this._app.database()}return this._cachedDatabase}init({storage:e,config:t}){if(e&&self.localStorage.init(e),t)try{this._app=s[t.databaseURL],this._app||(this._app=s[t.databaseURL]=firebase.initializeApp(t,t.databaseURL),t.apiKey&&t.apiKey.length<20&&(this._app.database().INTERNAL.forceWebSockets(),this._app.auth().useEmulator(t.databaseURL,{disableWarnings:!0}))),this._app.database(),this._app.auth(),this._configError=a._staticConfigError}catch(e){throw this._configError=e}else if(this._configError)throw this._configError;return{exposedFunctionNames:Object.keys(a._exposed),version:"dev",firebaseSdkVersion:firebase.SDK_VERSION}}destroy(){for(const s in this._callbacks){var e=this._callbacks[s];e.cancel&&e.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var t=r.indexOf(this);0<=t&&(r[t]=null)}enableFirebaseLogging({value:e}){firebase.database.enableLogging(e)}ping(){}bounceConnection(){this._database.goOffline(),this._database.goOnline()}_receive(e){a._firstMessageReceived=!0;for(const t of e.data)this._receiveMessage(t)}_receiveMessage(t){let s;try{var e=this[t.msg];if("function"!=typeof e)throw new Error("Unknown message: "+t.msg);t.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,t.writeSerial)),s=Promise.resolve(e.call(this,t))}catch(e){e.immediateFailure=!0,s=Promise.reject(e)}t.oneWay||s.then(e=>{this._send({msg:"resolve",id:t.id,result:e})},e=>{this._send({msg:"reject",id:t.id,error:i(e)})})}_send(e){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(e)}_flushMessageQueue(){this._port.postMessage(this._messages),this._messages=[]}call({name:e,args:t}){try{return Promise.resolve(a._exposed[e].apply(null,t))}catch(e){return Promise.reject(e)}}authWithCustomToken({authToken:e}){return this._auth.signInWithCustomToken(e).then(e=>n(e.user))}authAnonymously({}){return this._auth.signInAnonymously().then(e=>n(e.user))}unauth({}){return this._auth.signOut().catch(e=>{if(null!==this._auth.currentUser)return Promise.reject(e);for(const s in this._callbacks){var t;this._callbacks.hasOwnProperty(s)&&(t=this._callbacks[s]).auth&&t(null)}})}onAuth({callbackId:e}){e=this._callbacks[e]=this._onAuthCallback.bind(this,e);e.auth=!0,e.cancel=this._auth.onIdTokenChanged(e)}_onAuthCallback(t,e){n(e).then(e=>{!function t(s,r){if(s===r)return!0;if(null===s&&null===r||void 0===s&&void 0===r)return!0;if(null===s||null===r||void 0===s||void 0===r)return!1;if("object"!=typeof s||"object"!=typeof r)return!1;for(const e in s){if(!s.hasOwnProperty(e)||!r.hasOwnProperty(e))return!1;if(!t(s[e],r[e]))return!1}for(const a in r)if(!s.hasOwnProperty(a)||!r.hasOwnProperty(a))return!1;if(Array.isArray(s)||Array.isArray(r)){if(!Array.isArray(s)||!Array.isArray(r))return!1;if(s.length!==r.length)return!1;for(let e=0;e<s.length;e++)if(!t(s[e],r[e]))return!1}return!0}(this._lastJsonUser,e)&&(this._lastJsonUser=e,this._send({msg:"callback",id:t,args:[e]}))})}set({url:e,value:t}){return this._createRef(e).set(t)}update({url:e,value:t}){return this._createRef(e).update(t)}once({url:e}){return this._createRef(e).once("value").then(e=>this._snapshotToJson(e))}on({listenerKey:e,url:t,spec:s,eventType:r,callbackId:a,options:i}){(i=i||{}).sync&&(i.branch=new c),i.cancel=this.off.bind(this,{listenerKey:e,url:t,spec:s,eventType:r,callbackId:a});var n=this._callbacks[a]=this._onSnapshotCallback.bind(this,a,i),e=(n.listenerKey=e,n.eventType=r,n.cancel=i.cancel,this._onCancelCallback.bind(this,a));this._createRef(t,s).on(r,n,e)}off({listenerKey:e,url:t,spec:s,eventType:r,callbackId:a}){let i;if(a)i=this._callbacks[a],delete this._callbacks[a];else for(const o of Object.keys(this._callbacks)){var n;this._callbacks.hasOwnProperty(o)&&((n=this._callbacks[o]).listenerKey!==e||r&&n.eventType!==r||delete this._callbacks[o])}this._createRef(t,s).off(r,i)}_onSnapshotCallback(t,s,r){if(s.sync&&s.rest){var a=decodeURIComponent(r.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,""));let e;try{e=h(r.val())}catch(e){return s.cancel(),void this._onCancelCallback(t,e)}var i=s.branch.diff(e,a);for(const n in i)i.hasOwnProperty(n)&&this._send({msg:"callback",id:t,args:[null,{path:n,value:i[n],writeSerial:this._lastWriteSerial}]})}else try{var e=this._snapshotToJson(r);s.sync&&s.branch.set(e.value),this._send({msg:"callback",id:t,args:[null,e]}),s.rest=!0}catch(e){s.cancel(),this._onCancelCallback(t,e)}}_onCancelCallback(e,t){delete this._callbacks[e],this._send({msg:"callback",id:e,args:[i(t)]})}transaction({url:e,oldValue:s,relativeUpdates:i}){const a=decodeURIComponent(e.replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),t=this._createRef(e),n=new c;let o,l;return t.transaction(e=>{if(l=void 0,e=h(e),(o=!function e(t,s){if(t===s)return!0;if(null==t&&null==s)return!0;if(null===t||null===s)return!1;if("object"!=typeof t||"object"!=typeof s)return!1;for(const r in t){if(!t.hasOwnProperty(r)||!s.hasOwnProperty(r))return!1;if(!e(t[r],s[r]))return!1}for(const a in s)if(!t.hasOwnProperty(a)||!s.hasOwnProperty(a))return!1;return!0}(e,s))&&(e=s),i)for(const t in i)if(i.hasOwnProperty(t))if(t){var r=t.split("/");let s=e=null==e?{}:e;for(let t=0;t<r.length-1;t++){var a=r[t];let e=s[a];void 0!==e&&null!==e||(e=s[a]={}),s=e}s[r[r.length-1]]=i[t]}else e=i[t];if(n.set(e),!o)return l=e}).then(e=>{var t=[],s=n.diff(h(e.snapshot.val()),a);for(const r in s)s.hasOwnProperty(r)&&t.push({path:r,value:s[r],writeSerial:e.writeSerial||this._lastWriteSerial});return{committed:!o,snapshots:t}},e=>"set"===e.message||"disconnect"===e.message?t.once("value").then(e=>({committed:!1,snapshots:[e],writeSerial:this._lastWriteSerial})):(e.committedValue=l,Promise.reject(e)))}_snapshotToJson(e){return{path:decodeURIComponent(e.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),value:h(e.val()),writeSerial:this._lastWriteSerial}}onDisconnect({url:e,method:t,value:s}){return this._createRef(e).onDisconnect()[t](s)}_createRef(t,s){if(!this._app)throw new Error("Must provide Firebase configuration data first");try{let e=this._database.refFromURL(t);if(s){switch(s.by){case"$key":e=e.orderByKey();break;case"$value":e=e.orderByValue();break;default:e=e.orderByChild(s.by)}void 0!==s.at?e=e.equalTo(s.at):void 0!==s.from?e=e.startAt(s.from):void 0!==s.to&&(e=e.endAt(s.to)),void 0!==s.first?e=e.limitToFirst(s.first):void 0!==s.last&&(e=e.limitToLast(s.last))}return e}catch(e){throw e.extra={url:t,spec:s},e}}static expose(e,t){(t=t||e.name)||a._signalStaticConfigError(new Error("Cannot expose a function with no name: "+e)),a._exposed.hasOwnProperty(t)&&a._signalStaticConfigError(new Error(`Function ${t}() already exposed`)),a._firstMessageReceived&&a._signalStaticConfigError(new Error("Too late to expose function, worker in use")),a._exposed[t]=e}static setDatabaseWrapperCallback(e){a._databaseWrapperCallback&&a._signalStaticConfigError(new Error("Database wrapper callback already set")),a._firstMessageReceived&&a._signalStaticConfigError(new Error("Too late to set database wrapper callback, worker in use")),a._databaseWrapperCallback=e}static _signalStaticConfigError(e){a._staticConfigError||(a._staticConfigError=e);for(const t of r)t&&!t._configError&&(t._configError=e);throw e}}function i(e){var t={name:e.name,message:e.message};for(const s of Object.getOwnPropertyNames(e))t[s]=e[s];return t}function h(t){if(Array.isArray(t)){var s={};for(let e=0;e<t.length;e++){var r=t[e];null!=r&&(s[e]=h(r))}return s}if(t instanceof Object)for(const e in t)t.hasOwnProperty(e)&&(t[e]=h(t[e]));return t}function n(e){if(!e)return Promise.resolve(e);const t=e.toJSON();return delete t.stsTokenManager,e.getIdTokenResult().then(e=>(delete e.claims.exp,delete e.claims.iat,t.claims=e.claims,t))}return a._exposed={},a._firstMessageReceived=!1,a._databaseWrapperCallback=void 0,a._staticConfigError=void 0,self.window=self,"undefined"!=typeof onconnect?self.onconnect=function(e){r.push(new a(e.ports[0]))}:r.push(new a(self)),self.localStorage.flushPending(),a});
//# sourceMappingURL=worker.umd.min.js.map