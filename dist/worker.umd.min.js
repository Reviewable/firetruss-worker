!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():(e="undefined"!=typeof globalThis?globalThis:e||self).Fireworker=t()}(this,function(){"use strict";function e(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)}var a=[],n={},t={length:{configurable:!0}};e.prototype.init=function(e){this._initialized||(this._items=e,this._initialized=!0)},e.prototype._update=function(e){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(e)},e.prototype.flushPending=function(){this._pendingItems.length&&(a.length?(a[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]):setTimeout(this._flushPending,200))},t.length.get=function(){return this._items.length},e.prototype.key=function(e){return this._items[e].key},e.prototype.getItem=function(e){for(var t=0,r=this._items;t<r.length;t+=1){var n=r[t];if(n.key===e)return n.value}return null},e.prototype.setItem=function(e,t){for(var r,n=0,a=this._items;n<a.length;n+=1){var i=a[n];if(i.key===e){(r=i).value=t;break}}r||(r={key:e,value:t},this._items.push(r)),this._update(r)},e.prototype.removeItem=function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].key===e){this._items.splice(t,1),this._update({key:e,value:null});break}},e.prototype.clear=function(){for(var e in this._items)this._update({key:e.key,value:null});this._items=[]},Object.defineProperties(e.prototype,t),self.localStorage=new e;function f(){this._root=null}f.prototype.set=function(e){this._root=e},f.prototype.diff=function(e,t){var r={},n="/"===t?[""]:t.split("/");return this._diffRecursively(this._root,e,n,r)&&(this._root=e,r[t]=e),r},f.prototype._diffRecursively=function(e,t,r,n){if(void 0===e&&(e=null),void 0===t&&(t=null),null===e)return null!==t;if(!(e instanceof Object&&t instanceof Object))return t!==e;var a=!0,i=[];for(var s in t){t.hasOwnProperty(s)&&(this._diffRecursively(e[s],t[s],r.concat(s),n)?i.push(s):a=!1)}if(a)return!0;for(var o in e)e.hasOwnProperty(o)&&!t.hasOwnProperty(o)&&(n[r.concat(o).join("/")]=null,delete e[o]);for(var l=0,c=i;l<c.length;l+=1){var u=c[l];n[r.concat(u).join("/")]=t[u],e[u]=t[u]}};function i(e){this._port=e,this._lastWriteSerial=0,this._app=void 0,this._cachedAuth=void 0,this._cachedDatabase=void 0,this._lastJsonUser=void 0,this._configError=i._staticConfigError,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),e.onmessage=this._receive.bind(this)}var r={_auth:{configurable:!0},_database:{configurable:!0}};function s(e){for(var t={name:e.name,message:e.message},r=0,n=Object.getOwnPropertyNames(e);r<n.length;r+=1){var a=n[r];t[a]=e[a]}return t}function p(e){if(Array.isArray(e)){for(var t={},r=0;r<e.length;r++){var n=e[r];null!=n&&(t[r]=p(n))}return t}if(e instanceof Object)for(var a in e)e.hasOwnProperty(a)&&(e[a]=p(e[a]));return e}function o(e){if(!e)return Promise.resolve(e);var t=e.toJSON();return delete t.stsTokenManager,e.getIdTokenResult().then(function(e){return delete e.claims.exp,delete e.claims.iat,t.claims=e.claims,t})}return r._auth.get=function(){if(this._cachedAuth)return this._cachedAuth;if(!this._app)throw new Error("Must provide Firebase configuration data first");return this._cachedAuth=this._app.auth()},r._database.get=function(){if(this._cachedDatabase)return this._cachedDatabase;if(!this._app)throw new Error("Must provide Firebase configuration data first");return this._cachedDatabase=i._databaseWrapperCallback?i._databaseWrapperCallback(this._app.database()):this._app.database(),this._cachedDatabase},i.prototype.init=function(e){var t=e.storage,r=e.config;if(t&&self.localStorage.init(t),r)try{n[r.databaseURL]||(n[r.databaseURL]=firebase.initializeApp(r,r.databaseURL)),this._app=n[r.databaseURL],this._app.database(),this._app.auth(),this._configError=i._staticConfigError}catch(e){throw this._configError=e}else if(this._configError)throw this._configError;return{exposedFunctionNames:Object.keys(i._exposed),version:"2.4.1",firebaseSdkVersion:firebase.SDK_VERSION}},i.prototype.destroy=function(){for(var e in this._callbacks){var t=this._callbacks[e];t.cancel&&t.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var r=a.indexOf(this);0<=r&&(a[r]=null)},i.prototype.enableFirebaseLogging=function(e){var t=e.value;firebase.database.enableLogging(t)},i.prototype.ping=function(){},i.prototype.bounceConnection=function(){this._database.goOffline(),this._database.goOnline()},i.prototype._receive=function(e){i._firstMessageReceived=!0;for(var t=0,r=e.data;t<r.length;t+=1){var n=r[t];this._receiveMessage(n)}},i.prototype._receiveMessage=function(t){var r,n=this;try{var e=this[t.msg];if("function"!=typeof e)throw new Error("Unknown message: "+t.msg);t.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,t.writeSerial)),r=Promise.resolve(e.call(this,t))}catch(e){e.immediateFailure=!0,r=Promise.reject(e)}t.oneWay||r.then(function(e){n._send({msg:"resolve",id:t.id,result:e})},function(e){n._send({msg:"reject",id:t.id,error:s(e)})})},i.prototype._send=function(e){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(e)},i.prototype._flushMessageQueue=function(){this._port.postMessage(this._messages),this._messages=[]},i.prototype.call=function(e){var t=e.name,r=e.args;try{return Promise.resolve(i._exposed[t].apply(null,r))}catch(e){return Promise.reject(e)}},i.prototype.authWithCustomToken=function(e){e.url;var t=e.authToken;return this._auth.signInWithCustomToken(t).then(function(e){return o(e.user)})},i.prototype.authAnonymously=function(e){e.url;return this._auth.signInAnonymously().then(function(e){return o(e.user)})},i.prototype.unauth=function(e){var n=this;e.url;return this._auth.signOut().catch(function(e){if(null!==n._auth.currentUser)return Promise.reject(e);for(var t in n._callbacks){var r;n._callbacks.hasOwnProperty(t)&&((r=n._callbacks[t]).auth&&r(null))}})},i.prototype.onAuth=function(e){e.url;var t=e.callbackId,r=this._callbacks[t]=this._onAuthCallback.bind(this,t);r.auth=!0,r.cancel=this._auth.onIdTokenChanged(r)},i.prototype._onAuthCallback=function(t,e){var r=this;o(e).then(function(e){!function e(t,r){if(t===r)return!0;if(null===t&&null===r||void 0===t&&void 0===r)return!0;if(null===t||null===r||void 0===t||void 0===r)return!1;if("object"!=typeof t||"object"!=typeof r)return!1;for(var n in t){if(!t.hasOwnProperty(n)||!r.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}for(var a in r)if(!t.hasOwnProperty(a)||!r.hasOwnProperty(a))return!1;if(Array.isArray(t)||Array.isArray(r)){if(!Array.isArray(t)||!Array.isArray(r))return!1;if(t.length!==r.length)return!1;for(var i=0;i<t.length;i++)if(!e(t[i],r[i]))return!1}return!0}(r._lastJsonUser,e)&&(r._lastJsonUser=e,r._send({msg:"callback",id:t,args:[e]}))})},i.prototype.set=function(e){var t=e.url,r=e.value;return this._createRef(t).set(r)},i.prototype.update=function(e){var t=e.url,r=e.value;return this._createRef(t).update(r)},i.prototype.once=function(e){var t=this,r=e.url;return this._createRef(r).once("value").then(function(e){return t._snapshotToJson(e)})},i.prototype.on=function(e){var t=e.listenerKey,r=e.url,n=e.spec,a=e.eventType,i=e.callbackId,s=e.options;(s=s||{}).sync&&(s.branch=new f),s.cancel=this.off.bind(this,{listenerKey:t,url:r,spec:n,eventType:a,callbackId:i});var o=this._callbacks[i]=this._onSnapshotCallback.bind(this,i,s);o.listenerKey=t,o.eventType=a,o.cancel=s.cancel;var l=this._onCancelCallback.bind(this,i);this._createRef(r,n).on(a,o,l)},i.prototype.off=function(e){var t,r=e.listenerKey,n=e.url,a=e.spec,i=e.eventType,s=e.callbackId;if(s)t=this._callbacks[s],delete this._callbacks[s];else for(var o=0,l=Object.keys(this._callbacks);o<l.length;o+=1){var c,u=l[o];this._callbacks.hasOwnProperty(u)&&((c=this._callbacks[u]).listenerKey!==r||i&&c.eventType!==i||delete this._callbacks[u])}this._createRef(n,a).off(i,t)},i.prototype._onSnapshotCallback=function(t,r,e){if(r.sync&&r.rest){var n,a=decodeURIComponent(e.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,""));try{n=p(e.val())}catch(e){return r.cancel(),void this._onCancelCallback(t,e)}var i=r.branch.diff(n,a);for(var s in i)i.hasOwnProperty(s)&&this._send({msg:"callback",id:t,args:[null,{path:s,value:i[s],writeSerial:this._lastWriteSerial}]})}else try{var o=this._snapshotToJson(e);r.sync&&r.branch.set(o.value),this._send({msg:"callback",id:t,args:[null,o]}),r.rest=!0}catch(e){r.cancel(),this._onCancelCallback(t,e)}},i.prototype._onCancelCallback=function(e,t){delete this._callbacks[e],this._send({msg:"callback",id:e,args:[s(t)]})},i.prototype.transaction=function(e){var o,l,a=this,t=e.url,c=e.oldValue,u=e.relativeUpdates,i=decodeURIComponent(t.replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),r=this._createRef(t),h=new f;return r.transaction(function(e){if(l=void 0,e=p(e),(o=!function e(t,r){if(t===r)return!0;if(null==t&&null==r)return!0;if(null===t||null===r)return!1;if("object"!=typeof t||"object"!=typeof r)return!1;for(var n in t){if(!t.hasOwnProperty(n)||!r.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}for(var a in r)if(!t.hasOwnProperty(a)||!r.hasOwnProperty(a))return!1;return!0}(e,c))&&(e=c),u)for(var t in u)if(u.hasOwnProperty(t))if(t){var r=t.split("/");null==e&&(e={});for(var n=e,a=0;a<r.length-1;a++){var i=r[a],s=n[i];null==s&&(s=n[i]={}),n=s}n[r[r.length-1]]=u[t]}else e=u[t];if(h.set(e),!o)return l=e}).then(function(e){var t=[],r=h.diff(p(e.snapshot.val()),i);for(var n in r)r.hasOwnProperty(n)&&t.push({path:n,value:r[n],writeSerial:e.writeSerial||a._lastWriteSerial});return{committed:!o,snapshots:t}},function(e){return"set"===e.message||"disconnect"===e.message?r.once("value").then(function(e){return{committed:!1,snapshots:[e],writeSerial:a._lastWriteSerial}}):(e.committedValue=l,Promise.reject(e))})},i.prototype._snapshotToJson=function(e){return{path:decodeURIComponent(e.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),value:p(e.val()),writeSerial:this._lastWriteSerial}},i.prototype.onDisconnect=function(e){var t=e.url,r=e.method,n=e.value,a=this._createRef(t).onDisconnect();return a[r](n)},i.prototype._createRef=function(t,r){if(!this._app)throw new Error("Must provide Firebase configuration data first");try{var e=this._database.refFromURL(t);if(r){switch(r.by){case"$key":e=e.orderByKey();break;case"$value":e=e.orderByValue();break;default:e=e.orderByChild(r.by)}r.at?e=e.equalTo(r.at):r.from?e=e.startAt(r.from):r.to&&(e=e.endAt(r.to)),r.first?e=e.limitToFirst(r.first):r.last&&(e=e.limitToLast(r.last))}return e}catch(e){throw e.extra={url:t,spec:r},e}},i.expose=function(e,t){(t=t||e.name)||i._signalStaticConfigError(new Error("Cannot expose a function with no name: "+e)),i._exposed.hasOwnProperty(t)&&i._signalStaticConfigError(new Error("Function "+t+"() already exposed")),i._firstMessageReceived&&i._signalStaticConfigError(new Error("Too late to expose function, worker in use")),i._exposed[t]=e},i.setDatabaseWrapperCallback=function(e){i._databaseWrapperCallback&&i._signalStaticConfigError(new Error("Database wrapper callback already set")),i._firstMessageReceived&&i._signalStaticConfigError(new Error("Too late to set database wrapper callback, worker in use")),i._databaseWrapperCallback=e},i._signalStaticConfigError=function(e){i._staticConfigError||(i._staticConfigError=e);for(var t=0,r=a;t<r.length;t+=1){var n=r[t];n&&!n._configError&&(n._configError=e)}throw e},Object.defineProperties(i.prototype,r),i._exposed={},i._firstMessageReceived=!1,i._databaseWrapperCallback=void 0,i._staticConfigError=void 0,self.window=self,"undefined"!=typeof onconnect?self.onconnect=function(e){a.push(new i(e.ports[0]))}:a.push(new i(self)),self.localStorage.flushPending(),i});
//# sourceMappingURL=worker.umd.min.js.map