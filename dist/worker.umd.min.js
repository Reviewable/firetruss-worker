!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():(e="undefined"!=typeof globalThis?globalThis:e||self).Fireworker=t()}(this,function(){"use strict";function e(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)}var n=[],i={},t={length:{configurable:!0}};e.prototype.init=function(e){this._initialized||(this._items=e,this._initialized=!0)},e.prototype._update=function(e){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(e)},e.prototype.flushPending=function(){this._pendingItems.length&&(n.length?(n[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]):setTimeout(this._flushPending,200))},t.length.get=function(){return this._items.length},e.prototype.key=function(e){return this._items[e].key},e.prototype.getItem=function(e){for(var t=0,r=this._items;t<r.length;t+=1){var n=r[t];if(n.key===e)return n.value}return null},e.prototype.setItem=function(e,t){for(var r,n=0,i=this._items;n<i.length;n+=1){var s=i[n];if(s.key===e){(r=s).value=t;break}}r||(r={key:e,value:t},this._items.push(r)),this._update(r)},e.prototype.removeItem=function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].key===e){this._items.splice(t,1),this._update({key:e,value:null});break}},e.prototype.clear=function(){for(var e in this._items)this._update({key:e.key,value:null});this._items=[]},Object.defineProperties(e.prototype,t),self.localStorage=new e;function f(){this._root=null}f.prototype.set=function(e){this._root=e},f.prototype.diff=function(e,t){var r={},n="/"===t?[""]:t.split("/");return this._diffRecursively(this._root,e,n,r)&&(this._root=e,r[t]=e),r},f.prototype._diffRecursively=function(e,t,r,n){if(void 0===e&&(e=null),void 0===t&&(t=null),null===e)return null!==t;if(!(e instanceof Object&&t instanceof Object))return t!==e;var i=!0,s=[];for(var a in t){t.hasOwnProperty(a)&&(this._diffRecursively(e[a],t[a],r.concat(a),n)?s.push(a):i=!1)}if(i)return!0;for(var o in e)e.hasOwnProperty(o)&&!t.hasOwnProperty(o)&&(n[r.concat(o).join("/")]=null,delete e[o]);for(var l=0,c=s;l<c.length;l+=1){var u=c[l];n[r.concat(u).join("/")]=t[u],e[u]=t[u]}};function s(e){this._port=e,this._lastWriteSerial=0,this._lastJsonUser=void 0,this._configError=void 0,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),e.onmessage=this._receive.bind(this)}function a(e){for(var t={name:e.name,message:e.message},r=0,n=Object.getOwnPropertyNames(e);r<n.length;r+=1){var i=n[r];t[i]=e[i]}return t}function p(e){if(Array.isArray(e)){for(var t={},r=0;r<e.length;r++){var n=e[r];null!=n&&(t[r]=p(n))}return t}if(e instanceof Object)for(var i in e)e.hasOwnProperty(i)&&(e[i]=p(e[i]));return e}function o(e){if(!e)return Promise.resolve(e);var t=e.toJSON();return delete t.stsTokenManager,e.getIdTokenResult().then(function(e){return delete e.claims.exp,delete e.claims.iat,t.claims=e.claims,t})}return s.prototype.init=function(e){var t=e.storage,r=e.config;if(t&&self.localStorage.init(t),r)try{i[r.databaseURL]||(i[r.databaseURL]=firebase.initializeApp(r,r.databaseURL)),this._app=i[r.databaseURL],this._app.database(),this._app.auth(),this._configError=void 0}catch(e){throw this._configError=e}else if(this._configError)throw this._configError;return{exposedFunctionNames:Object.keys(s._exposed),version:"2.3.0",firebaseSdkVersion:firebase.SDK_VERSION}},s.prototype.destroy=function(){for(var e in this._callbacks){var t=this._callbacks[e];t.cancel&&t.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var r=n.indexOf(this);0<=r&&(n[r]=null)},s.prototype.enableFirebaseLogging=function(e){var t=e.value;firebase.database.enableLogging(t)},s.prototype.ping=function(){},s.prototype.bounceConnection=function(){if(!this._app)throw new Error("Must provide Firebase configuration data first");this._app.database().goOffline(),this._app.database().goOnline()},s.prototype._receive=function(e){s._firstMessageReceived=!0;for(var t=0,r=e.data;t<r.length;t+=1){var n=r[t];this._receiveMessage(n)}},s.prototype._receiveMessage=function(t){var r,n=this;try{var e=this[t.msg];if("function"!=typeof e)throw new Error("Unknown message: "+t.msg);t.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,t.writeSerial)),r=Promise.resolve(e.call(this,t))}catch(e){e.immediateFailure=!0,r=Promise.reject(e)}t.oneWay||r.then(function(e){n._send({msg:"resolve",id:t.id,result:e})},function(e){n._send({msg:"reject",id:t.id,error:a(e)})})},s.prototype._send=function(e){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(e)},s.prototype._flushMessageQueue=function(){this._port.postMessage(this._messages),this._messages=[]},s.prototype.call=function(e){var t=e.name,r=e.args;try{return Promise.resolve(s._exposed[t].apply(null,r))}catch(e){return Promise.reject(e)}},s.prototype.authWithCustomToken=function(e){e.url;var t=e.authToken;return this._app.auth().signInWithCustomToken(t).then(function(e){return o(e.user)})},s.prototype.authAnonymously=function(e){e.url;return this._app.auth().signInAnonymously().then(function(e){return o(e.user)})},s.prototype.unauth=function(e){var n=this;e.url;return this._app.auth().signOut().catch(function(e){if(null!==n._app.auth().currentUser)return Promise.reject(e);for(var t in n._callbacks){var r;n._callbacks.hasOwnProperty(t)&&((r=n._callbacks[t]).auth&&r(null))}})},s.prototype.onAuth=function(e){e.url;var t=e.callbackId,r=this._callbacks[t]=this._onAuthCallback.bind(this,t);r.auth=!0,r.cancel=this._app.auth().onIdTokenChanged(r)},s.prototype._onAuthCallback=function(t,e){var r=this;o(e).then(function(e){!function e(t,r){if(t===r)return!0;if(null===t&&null===r||void 0===t&&void 0===r)return!0;if(null===t||null===r||void 0===t||void 0===r)return!1;if("object"!=typeof t||"object"!=typeof r)return!1;for(var n in t){if(!t.hasOwnProperty(n)||!r.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}for(var i in r)if(!t.hasOwnProperty(i)||!r.hasOwnProperty(i))return!1;if(Array.isArray(t)||Array.isArray(r)){if(!Array.isArray(t)||!Array.isArray(r))return!1;if(t.length!==r.length)return!1;for(var s=0;s<t.length;s++)if(!e(t[s],r[s]))return!1}return!0}(r._lastJsonUser,e)&&(r._lastJsonUser=e,r._send({msg:"callback",id:t,args:[e]}))})},s.prototype.set=function(e){var t=e.url,r=e.value;return this._createRef(t).set(r)},s.prototype.update=function(e){var t=e.url,r=e.value;return this._createRef(t).update(r)},s.prototype.once=function(e){var t=this,r=e.url;return this._createRef(r).once("value").then(function(e){return t._snapshotToJson(e)})},s.prototype.on=function(e){var t=e.listenerKey,r=e.url,n=e.spec,i=e.eventType,s=e.callbackId,a=e.options;(a=a||{}).sync&&(a.branch=new f),a.cancel=this.off.bind(this,{listenerKey:t,url:r,spec:n,eventType:i,callbackId:s});var o=this._callbacks[s]=this._onSnapshotCallback.bind(this,s,a);o.listenerKey=t,o.eventType=i,o.cancel=a.cancel;var l=this._onCancelCallback.bind(this,s);this._createRef(r,n).on(i,o,l)},s.prototype.off=function(e){var t,r=e.listenerKey,n=e.url,i=e.spec,s=e.eventType,a=e.callbackId;if(a)t=this._callbacks[a],delete this._callbacks[a];else for(var o=0,l=Object.keys(this._callbacks);o<l.length;o+=1){var c,u=l[o];this._callbacks.hasOwnProperty(u)&&((c=this._callbacks[u]).listenerKey!==r||s&&c.eventType!==s||delete this._callbacks[u])}this._createRef(n,i).off(s,t)},s.prototype._onSnapshotCallback=function(t,r,e){if(r.sync&&r.rest){var n,i=decodeURIComponent(e.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,""));try{n=p(e.val())}catch(e){return r.cancel(),void this._onCancelCallback(t,e)}var s=r.branch.diff(n,i);for(var a in s)s.hasOwnProperty(a)&&this._send({msg:"callback",id:t,args:[null,{path:a,value:s[a],writeSerial:this._lastWriteSerial}]})}else try{var o=this._snapshotToJson(e);r.sync&&r.branch.set(o.value),this._send({msg:"callback",id:t,args:[null,o]}),r.rest=!0}catch(e){r.cancel(),this._onCancelCallback(t,e)}},s.prototype._onCancelCallback=function(e,t){delete this._callbacks[e],this._send({msg:"callback",id:e,args:[a(t)]})},s.prototype.transaction=function(e){var o,l,i=this,t=e.url,c=e.oldValue,u=e.relativeUpdates,s=decodeURIComponent(t.replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),r=this._createRef(t),h=new f;return r.transaction(function(e){if(l=void 0,e=p(e),(o=!function e(t,r){if(t===r)return!0;if(null==t&&null==r)return!0;if(null===t||null===r)return!1;if("object"!=typeof t||"object"!=typeof r)return!1;for(var n in t){if(!t.hasOwnProperty(n)||!r.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}for(var i in r)if(!t.hasOwnProperty(i)||!r.hasOwnProperty(i))return!1;return!0}(e,c))&&(e=c),u)for(var t in u)if(u.hasOwnProperty(t))if(t){var r=t.split("/");null==e&&(e={});for(var n=e,i=0;i<r.length-1;i++){var s=r[i],a=n[s];null==a&&(a=n[s]={}),n=a}n[r[r.length-1]]=u[t]}else e=u[t];if(h.set(e),!o)return l=e}).then(function(e){var t=[],r=h.diff(p(e.snapshot.val()),s);for(var n in r)r.hasOwnProperty(n)&&t.push({path:n,value:r[n],writeSerial:e.writeSerial||i._lastWriteSerial});return{committed:!o,snapshots:t}},function(e){return"set"===e.message||"disconnect"===e.message?r.once("value").then(function(e){return{committed:!1,snapshots:[e],writeSerial:i._lastWriteSerial}}):(e.committedValue=l,Promise.reject(e))})},s.prototype._snapshotToJson=function(e){return{path:decodeURIComponent(e.ref.toString().replace(/.*?:\/\/[^/]*/,"").replace(/\/$/,"")),value:p(e.val()),writeSerial:this._lastWriteSerial}},s.prototype.onDisconnect=function(e){var t=e.url,r=e.method,n=e.value,i=this._createRef(t).onDisconnect();return i[r](n)},s.prototype._createRef=function(t,r){if(!this._app)throw new Error("Must provide Firebase configuration data first");try{var e=this._app.database().refFromURL(t);if(r){switch(r.by){case"$key":e=e.orderByKey();break;case"$value":e=e.orderByValue();break;default:e=e.orderByChild(r.by)}r.at?e=e.equalTo(r.at):r.from?e=e.startAt(r.from):r.to&&(e=e.endAt(r.to)),r.first?e=e.limitToFirst(r.first):r.last&&(e=e.limitToLast(r.last))}return e}catch(e){throw e.extra={url:t,spec:r},e}},s.expose=function(e,t){if(!(t=t||e.name))throw new Error("Cannot expose a function with no name: "+e);if(s._exposed.hasOwnProperty(t))throw new Error("Function "+t+"() already exposed");if(s._firstMessageReceived)throw new Error("Too late to expose function, worker in use");s._exposed[t]=e},s._exposed={},s._firstMessageReceived=!1,self.window=self,"undefined"!=typeof onconnect?self.onconnect=function(e){n.push(new s(e.ports[0]))}:n.push(new s(self)),self.localStorage.flushPending(),s});
//# sourceMappingURL=worker.umd.min.js.map