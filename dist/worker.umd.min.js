!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Fireworker=b()}(this,function(){"use strict";function a(a){for(var b={name:a.name},c=Object.getOwnPropertyNames(a),d=0,e=c;d<e.length;d+=1){var f=e[d];b[f]=a[f]}return b}function b(a){if(Array.isArray(a)){for(var c={},d=0;d<a.length;d++){var e=a[d];void 0!==e&&null!==e&&(c[d]=b(e))}return c}if(a instanceof Object)for(var f in a)a.hasOwnProperty(f)&&(a[f]=b(a[f]));return a}function c(a,b){if(a===b)return!0;if(!(null!==a&&void 0!==a||null!==b&&void 0!==b))return!0;if(null===a||null===b)return!1;if("object"!=typeof a||"object"!=typeof b)return!1;for(var d in a){if(!a.hasOwnProperty(d)||!b.hasOwnProperty(d))return!1;if(!c(a[d],b[d]))return!1}for(var e in b)if(!a.hasOwnProperty(e)||!b.hasOwnProperty(e))return!1;return!0}function d(){"undefined"!=typeof onconnect?self.onconnect=function(a){e.push(new j(a.ports[0]))}:e.push(new j(self)),self.localStorage.flushPending()}var e=[],f={},g=function(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)},h={length:{}};g.prototype.init=function(a){this._initialized||(this._items=a,this._initialized=!0)},g.prototype._update=function(a){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(a)},g.prototype.flushPending=function(){if(this._pendingItems.length){if(!e.length)return void setTimeout(this._flushPending,200);e[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]}},h.length.get=function(){return this._items.length},g.prototype.key=function(a){return this._items[a].key},g.prototype.getItem=function(a){for(var b=this,c=0,d=b._items;c<d.length;c+=1){var e=d[c];if(e.key===a)return e.value}return null},g.prototype.setItem=function(a,b){for(var c,d=this,e=0,f=d._items;e<f.length;e+=1){var g=f[e];if(g.key===a){c=g,g.value=b;break}}c||(c={key:a,value:b},this._items.push(c)),this._update(c)},g.prototype.removeItem=function(a){for(var b=this,c=0;c<this._items.length;c++)if(b._items[c].key===a){b._items.splice(c,1),b._update({key:a,value:null});break}},g.prototype.clear=function(){var a=this;for(var b in a._items)a._update({key:b.key,value:null});this._items=[]},Object.defineProperties(g.prototype,h),self.localStorage=new g;var i=function(){this._root=null};i.prototype.set=function(a){this._root=a},i.prototype.diff=function(a,b){var c={},d="/"===b?[""]:b.split("/");return this._diffRecursively(this._root,a,d,c)&&(this._root=a,c[b]=a),c},i.prototype._diffRecursively=function(a,b,c,d){var e=this;if(void 0===a&&(a=null),void 0===b&&(b=null),null===a)return null!==b;if(!(a instanceof Object&&b instanceof Object))return b!==a;var f=!0,g=[];for(var h in b)if(b.hasOwnProperty(h)){var i=e._diffRecursively(a[h],b[h],c.concat(h),d);i?g.push(h):f=!1}if(f)return!0;for(var j in a)a.hasOwnProperty(j)&&!b.hasOwnProperty(j)&&(d[c.concat(j).join("/")]=null,delete a[j]);for(var k=0,l=g;k<l.length;k+=1){var m=l[k];d[c.concat(m).join("/")]=b[m],a[m]=b[m]}};var j=function(a){this.ping(),this._port=a,this._lastWriteSerial=0,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),a.onmessage=this._receive.bind(this)};j.prototype.init=function(a){var b=a.storage,c=a.config;return b&&self.localStorage.init(b),c&&(f[c.databaseURL]||(f[c.databaseURL]=firebase.initializeApp(c,c.databaseURL)),this._app=f[c.databaseURL],this._app.database(),this._app.auth()),{exposedFunctionNames:Object.keys(j._exposed),version:"0.8.2",firebaseSdkVersion:firebase.SDK_VERSION}},j.prototype.destroy=function(){var a=this;for(var b in a._callbacks){var c=a._callbacks[b];c.cancel&&c.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var d=e.indexOf(this);d>=0&&(e[d]=null)},j.prototype.ping=function(){this.lastTouched=Date.now()},j.prototype.bounceConnection=function(){if(!this._app)throw new Error("Must provide Firebase configuration data first");this._app.database().goOffline(),this._app.database().goOnline()},j.prototype._receive=function(a){var b=this;j._firstMessageReceived=!0,this.lastTouched=Date.now();for(var c=0,d=a.data;c<d.length;c+=1){var e=d[c];b._receiveMessage(e)}},j.prototype._receiveMessage=function(b){var c,d=this;try{var e=this[b.msg];if("function"!=typeof e)throw new Error("Unknown message: "+b.msg);b.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,b.writeSerial)),c=Promise.resolve(e.call(this,b))}catch(a){a.immediateFailure=!0,c=Promise.reject(a)}b.oneWay||c.then(function(a){d._send({msg:"resolve",id:b.id,result:a})},function(c){d._send({msg:"reject",id:b.id,error:a(c)})})},j.prototype._send=function(a){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(a)},j.prototype._flushMessageQueue=function(){this._port.postMessage(this._messages),this._messages=[]},j.prototype.call=function(a){var b=a.name,c=a.args;try{return Promise.resolve(j._exposed[b].apply(null,c))}catch(a){return Promise.reject(a)}},j.prototype.authWithCustomToken=function(a){var b=(a.url,a.authToken);return this._app.auth().signInWithCustomToken(b).then(function(a){return a.user&&a.user.toJSON()})},j.prototype.unauth=function(a){a.url;return this._app.auth().signOut()},j.prototype.onAuth=function(a){var b=(a.url,a.callbackId),c=this._callbacks[b]=this._onAuthCallback.bind(this,b);c.cancel=this._app.auth().onAuthStateChanged(c)},j.prototype._onAuthCallback=function(a,b){this._send({msg:"callback",id:a,args:[b&&b.toJSON()]})},j.prototype.set=function(a){var b=a.url,c=a.value;return this._createRef(b).set(c)},j.prototype.update=function(a){var b=a.url,c=a.value;return this._createRef(b).update(c)},j.prototype.once=function(a){var b=this,c=a.url;return this._createRef(c).once("value").then(function(a){return b._snapshotToJson(a)})},j.prototype.on=function(a){var b=a.listenerKey,c=a.url,d=a.spec,e=a.eventType,f=a.callbackId,g=a.options;g=g||{},g.sync&&(g.branch=new i),g.cancel=this.off.bind(this,{listenerKey:b,url:c,spec:d,eventType:e,callbackId:f});var h=this._callbacks[f]=this._onSnapshotCallback.bind(this,f,g);h.listenerKey=b,h.eventType=e,h.cancel=g.cancel;var j=this._onCancelCallback.bind(this,f);this._createRef(c,d).on(e,h,j)},j.prototype.off=function(a){var b,c=this,d=a.listenerKey,e=a.url,f=a.spec,g=a.eventType,h=a.callbackId;if(h)b=this._callbacks[h],delete this._callbacks[h];else for(var i=0,j=Object.keys(c._callbacks);i<j.length;i+=1){var k=j[i];if(c._callbacks.hasOwnProperty(k)){var l=c._callbacks[k];l.listenerKey!==d||g&&l.eventType!==g||delete c._callbacks[k]}}this._createRef(e,f).off(g,b)},j.prototype._onSnapshotCallback=function(a,c,d){var e=this;if(c.sync&&c.rest){var f,g=decodeURIComponent(d.ref.toString().replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,""));try{f=b(d.val())}catch(b){return c.cancel(),void this._onCancelCallback(a,b)}var h=c.branch.diff(f,g);for(var i in h)h.hasOwnProperty(i)&&e._send({msg:"callback",id:a,args:[null,{path:i,value:h[i],writeSerial:e._lastWriteSerial}]})}else try{var j=this._snapshotToJson(d);c.sync&&c.branch.set(j.value),this._send({msg:"callback",id:a,args:[null,j]}),c.rest=!0}catch(b){c.cancel(),this._onCancelCallback(a,b)}},j.prototype._onCancelCallback=function(b,c){delete this._callbacks[b],this._send({msg:"callback",id:b,args:[a(c)]})},j.prototype.transaction=function(a){var d,e,f=this,g=a.url,h=a.oldValue,j=a.relativeUpdates,k=decodeURIComponent(g.replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,"")),l=this._createRef(g),m=new i;return l.transaction(function(a){if(e=void 0,a=b(a),d=!c(a,h),d&&(a=h),j)for(var f in j)if(j.hasOwnProperty(f))if(f){var g=f.split("/");void 0!==a&&null!==a||(a={});for(var i=a,k=0;k<g.length-1;k++){var l=g[k],n=i[l];void 0!==n&&null!==n||(n=i[l]={}),i=n}i[g[g.length-1]]=j[f]}else a=j[f];if(m.set(a),!d)return e=a,a}).then(function(a){var c=[],e=m.diff(b(a.snapshot.val()),k);for(var g in e)e.hasOwnProperty(g)&&c.push({path:g,value:e[g],writeSerial:a.writeSerial||f._lastWriteSerial});return{committed:!d,snapshots:c}},function(a){return"set"===a.message||"disconnect"===a.message?l.once("value").then(function(a){return{committed:!1,snapshots:[a],writeSerial:f._lastWriteSerial}}):(a.committedValue=e,Promise.reject(a))})},j.prototype._snapshotToJson=function(a){return{path:decodeURIComponent(a.ref.toString().replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,"")),value:b(a.val()),writeSerial:this._lastWriteSerial}},j.prototype.onDisconnect=function(a){var b=a.url,c=a.method,d=a.value;return this._createRef(b).onDisconnect()[c](d)},j.prototype._createRef=function(a,b){if(!this._app)throw new Error("Must provide Firebase configuration data first");try{var c=this._app.database().refFromURL(a);if(b){switch(b.by){case"$key":c=c.orderByKey();break;case"$value":c=c.orderByValue();break;default:c=c.orderByChild(b.by)}b.at?c=c.equalTo(b.at):b.from?c=c.startAt(b.from):b.to&&(c=c.endAt(b.to)),b.first?c=c.limitToFirst(b.first):b.last&&(c=c.limitToLast(b.last))}return c}catch(c){throw c.extra={url:a,spec:b},c}},j.expose=function(a,b){if(b=b||a.name,!b)throw new Error("Cannot expose a function with no name: "+a);if(j._exposed.hasOwnProperty(b))throw new Error("Function "+b+"() already exposed");if(j._firstMessageReceived)throw new Error("Too late to expose function, worker in use");j._exposed[b]=a},j._exposed={},j._firstMessageReceived=!1;var k=Date.now();return setInterval(function(){var a=Date.now(),b=a-k-6e4;k=a,e.forEach(function(c){c&&(b>=1e3&&c.lastTouched<=a-b&&(c.lastTouched+=b),a-c.lastTouched>=18e4&&c.destroy())});for(var c;(c=e.indexOf(null))>=0;)e.splice(c,1)},6e4),self.window=self,d(),j});
//# sourceMappingURL=worker.umd.min.js.map