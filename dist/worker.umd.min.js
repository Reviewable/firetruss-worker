!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Fireworker=b()}(this,function(){"use strict";function a(a){for(var b={name:a.name,message:a.message},c=Object.getOwnPropertyNames(a),d=0,e=c;d<e.length;d+=1){var f=e[d];b[f]=a[f]}return b}function b(a){if(Array.isArray(a)){for(var c={},d=0;d<a.length;d++){var e=a[d];void 0!==e&&null!==e&&(c[d]=b(e))}return c}if(a instanceof Object)for(var f in a)a.hasOwnProperty(f)&&(a[f]=b(a[f]));return a}function c(a){if(!a)return Promise.resolve(a);var b=a.toJSON();return delete b.stsTokenManager,a.getIdTokenResult().then(function(a){return delete a.claims.exp,delete a.claims.iat,b.claims=a.claims,b})}function d(a,b){if(a===b)return!0;if(!(null!==a&&void 0!==a||null!==b&&void 0!==b))return!0;if(null===a||null===b)return!1;if("object"!=typeof a||"object"!=typeof b)return!1;for(var c in a){if(!a.hasOwnProperty(c)||!b.hasOwnProperty(c))return!1;if(!d(a[c],b[c]))return!1}for(var e in b)if(!a.hasOwnProperty(e)||!b.hasOwnProperty(e))return!1;return!0}function e(a,b){if(a===b)return!0;if(null===a&&null===b||void 0===a&&void 0===b)return!0;if(null===a||null===b||void 0===a||void 0===b)return!1;if("object"!=typeof a||"object"!=typeof b)return!1;for(var c in a){if(!a.hasOwnProperty(c)||!b.hasOwnProperty(c))return!1;if(!e(a[c],b[c]))return!1}for(var d in b)if(!a.hasOwnProperty(d)||!b.hasOwnProperty(d))return!1;if(Array.isArray(a)||Array.isArray(b)){if(!Array.isArray(a)||!Array.isArray(b))return!1;if(a.length!==b.length)return!1;for(var f=0;f<a.length;f++)if(!e(a[f],b[f]))return!1}return!0}function f(){"undefined"!=typeof onconnect?self.onconnect=function(a){g.push(new l(a.ports[0]))}:g.push(new l(self)),self.localStorage.flushPending()}var g=[],h={},i=function(){this._items=[],this._pendingItems=[],this._initialized=!1,this._flushPending=this.flushPending.bind(this)},j={length:{}};i.prototype.init=function(a){this._initialized||(this._items=a,this._initialized=!0)},i.prototype._update=function(a){this._pendingItems.length||Promise.resolve().then(this._flushPending),this._pendingItems.push(a)},i.prototype.flushPending=function(){if(this._pendingItems.length){if(!g.length)return void setTimeout(this._flushPending,200);g[0]._send({msg:"updateLocalStorage",items:this._pendingItems}),this._pendingItems=[]}},j.length.get=function(){return this._items.length},i.prototype.key=function(a){return this._items[a].key},i.prototype.getItem=function(a){for(var b=this,c=0,d=b._items;c<d.length;c+=1){var e=d[c];if(e.key===a)return e.value}return null},i.prototype.setItem=function(a,b){for(var c,d=this,e=0,f=d._items;e<f.length;e+=1){var g=f[e];if(g.key===a){c=g,g.value=b;break}}c||(c={key:a,value:b},this._items.push(c)),this._update(c)},i.prototype.removeItem=function(a){for(var b=this,c=0;c<this._items.length;c++)if(b._items[c].key===a){b._items.splice(c,1),b._update({key:a,value:null});break}},i.prototype.clear=function(){var a=this;for(var b in a._items)a._update({key:b.key,value:null});this._items=[]},Object.defineProperties(i.prototype,j),self.localStorage=new i;var k=function(){this._root=null};k.prototype.set=function(a){this._root=a},k.prototype.diff=function(a,b){var c={},d="/"===b?[""]:b.split("/");return this._diffRecursively(this._root,a,d,c)&&(this._root=a,c[b]=a),c},k.prototype._diffRecursively=function(a,b,c,d){var e=this;if(void 0===a&&(a=null),void 0===b&&(b=null),null===a)return null!==b;if(!(a instanceof Object&&b instanceof Object))return b!==a;var f=!0,g=[];for(var h in b)if(b.hasOwnProperty(h)){var i=e._diffRecursively(a[h],b[h],c.concat(h),d);i?g.push(h):f=!1}if(f)return!0;for(var j in a)a.hasOwnProperty(j)&&!b.hasOwnProperty(j)&&(d[c.concat(j).join("/")]=null,delete a[j]);for(var k=0,l=g;k<l.length;k+=1){var m=l[k];d[c.concat(m).join("/")]=b[m],a[m]=b[m]}};var l=function(a){this._port=a,this._lastWriteSerial=0,this._lastJsonUser=void 0,this._configError=void 0,this._callbacks={},this._messages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),a.onmessage=this._receive.bind(this)};return l.prototype.init=function(a){var b=a.storage,c=a.config;if(b&&self.localStorage.init(b),c)try{h[c.databaseURL]||(h[c.databaseURL]=firebase.initializeApp(c,c.databaseURL)),this._app=h[c.databaseURL],this._app.database(),this._app.auth(),this._configError=void 0}catch(a){throw this._configError=a,a}else if(this._configError)throw this._configError;return{exposedFunctionNames:Object.keys(l._exposed),version:"2.0.0",firebaseSdkVersion:firebase.SDK_VERSION}},l.prototype.destroy=function(){var a=this;for(var b in a._callbacks){var c=a._callbacks[b];c.cancel&&c.cancel()}this._callbacks={},this._port.onmessage=null,this._messages=[];var d=g.indexOf(this);d>=0&&(g[d]=null)},l.prototype.ping=function(){},l.prototype.bounceConnection=function(){if(!this._app)throw new Error("Must provide Firebase configuration data first");this._app.database().goOffline(),this._app.database().goOnline()},l.prototype._receive=function(a){var b=this;l._firstMessageReceived=!0;for(var c=0,d=a.data;c<d.length;c+=1){var e=d[c];b._receiveMessage(e)}},l.prototype._receiveMessage=function(b){var c,d=this;try{var e=this[b.msg];if("function"!=typeof e)throw new Error("Unknown message: "+b.msg);b.writeSerial&&(this._lastWriteSerial=Math.max(this._lastWriteSerial,b.writeSerial)),c=Promise.resolve(e.call(this,b))}catch(a){a.immediateFailure=!0,c=Promise.reject(a)}b.oneWay||c.then(function(a){d._send({msg:"resolve",id:b.id,result:a})},function(c){d._send({msg:"reject",id:b.id,error:a(c)})})},l.prototype._send=function(a){this._messages.length||Promise.resolve().then(this._flushMessageQueue),this._messages.push(a)},l.prototype._flushMessageQueue=function(){this._port.postMessage(this._messages),this._messages=[]},l.prototype.call=function(a){var b=a.name,c=a.args;try{return Promise.resolve(l._exposed[b].apply(null,c))}catch(a){return Promise.reject(a)}},l.prototype.authWithCustomToken=function(a){var b=(a.url,a.authToken);return this._app.auth().signInWithCustomToken(b).then(function(a){return c(a.user)})},l.prototype.unauth=function(a){var b=this;a.url;return this._app.auth().signOut().catch(function(a){if(null!==b._app.auth().currentUser)return Promise.reject(a);for(var c in b._callbacks)if(b._callbacks.hasOwnProperty(c)){var d=b._callbacks[c];d.auth&&d(null)}})},l.prototype.onAuth=function(a){var b=(a.url,a.callbackId),c=this._callbacks[b]=this._onAuthCallback.bind(this,b);c.auth=!0,c.cancel=this._app.auth().onIdTokenChanged(c)},l.prototype._onAuthCallback=function(a,b){var d=this;c(b).then(function(b){e(d._lastJsonUser,b)||(d._lastJsonUser=b,d._send({msg:"callback",id:a,args:[b]}))})},l.prototype.set=function(a){var b=a.url,c=a.value;return this._createRef(b).set(c)},l.prototype.update=function(a){var b=a.url,c=a.value;return this._createRef(b).update(c)},l.prototype.once=function(a){var b=this,c=a.url;return this._createRef(c).once("value").then(function(a){return b._snapshotToJson(a)})},l.prototype.on=function(a){var b=a.listenerKey,c=a.url,d=a.spec,e=a.eventType,f=a.callbackId,g=a.options;g=g||{},g.sync&&(g.branch=new k),g.cancel=this.off.bind(this,{listenerKey:b,url:c,spec:d,eventType:e,callbackId:f});var h=this._callbacks[f]=this._onSnapshotCallback.bind(this,f,g);h.listenerKey=b,h.eventType=e,h.cancel=g.cancel;var i=this._onCancelCallback.bind(this,f);this._createRef(c,d).on(e,h,i)},l.prototype.off=function(a){var b,c=this,d=a.listenerKey,e=a.url,f=a.spec,g=a.eventType,h=a.callbackId;if(h)b=this._callbacks[h],delete this._callbacks[h];else for(var i=0,j=Object.keys(c._callbacks);i<j.length;i+=1){var k=j[i];if(c._callbacks.hasOwnProperty(k)){var l=c._callbacks[k];l.listenerKey!==d||g&&l.eventType!==g||delete c._callbacks[k]}}this._createRef(e,f).off(g,b)},l.prototype._onSnapshotCallback=function(a,c,d){var e=this;if(c.sync&&c.rest){var f,g=decodeURIComponent(d.ref.toString().replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,""));try{f=b(d.val())}catch(b){return c.cancel(),void this._onCancelCallback(a,b)}var h=c.branch.diff(f,g);for(var i in h)h.hasOwnProperty(i)&&e._send({msg:"callback",id:a,args:[null,{path:i,value:h[i],writeSerial:e._lastWriteSerial}]})}else try{var j=this._snapshotToJson(d);c.sync&&c.branch.set(j.value),this._send({msg:"callback",id:a,args:[null,j]}),c.rest=!0}catch(b){c.cancel(),this._onCancelCallback(a,b)}},l.prototype._onCancelCallback=function(b,c){delete this._callbacks[b],this._send({msg:"callback",id:b,args:[a(c)]})},l.prototype.transaction=function(a){var c,e,f=this,g=a.url,h=a.oldValue,i=a.relativeUpdates,j=decodeURIComponent(g.replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,"")),l=this._createRef(g),m=new k;return l.transaction(function(a){if(e=void 0,a=b(a),c=!d(a,h),c&&(a=h),i)for(var f in i)if(i.hasOwnProperty(f))if(f){var g=f.split("/");void 0!==a&&null!==a||(a={});for(var j=a,k=0;k<g.length-1;k++){var l=g[k],n=j[l];void 0!==n&&null!==n||(n=j[l]={}),j=n}j[g[g.length-1]]=i[f]}else a=i[f];if(m.set(a),!c)return e=a,a}).then(function(a){var d=[],e=m.diff(b(a.snapshot.val()),j);for(var g in e)e.hasOwnProperty(g)&&d.push({path:g,value:e[g],writeSerial:a.writeSerial||f._lastWriteSerial});return{committed:!c,snapshots:d}},function(a){return"set"===a.message||"disconnect"===a.message?l.once("value").then(function(a){return{committed:!1,snapshots:[a],writeSerial:f._lastWriteSerial}}):(a.committedValue=e,Promise.reject(a))})},l.prototype._snapshotToJson=function(a){return{path:decodeURIComponent(a.ref.toString().replace(/.*?:\/\/[^\/]*/,"").replace(/\/$/,"")),value:b(a.val()),writeSerial:this._lastWriteSerial}},l.prototype.onDisconnect=function(a){var b=a.url,c=a.method,d=a.value;return this._createRef(b).onDisconnect()[c](d)},l.prototype._createRef=function(a,b){if(!this._app)throw new Error("Must provide Firebase configuration data first");try{var c=this._app.database().refFromURL(a);if(b){switch(b.by){case"$key":c=c.orderByKey();break;case"$value":c=c.orderByValue();break;default:c=c.orderByChild(b.by)}b.at?c=c.equalTo(b.at):b.from?c=c.startAt(b.from):b.to&&(c=c.endAt(b.to)),b.first?c=c.limitToFirst(b.first):b.last&&(c=c.limitToLast(b.last))}return c}catch(c){throw c.extra={url:a,spec:b},c}},l.expose=function(a,b){if(b=b||a.name,!b)throw new Error("Cannot expose a function with no name: "+a);if(l._exposed.hasOwnProperty(b))throw new Error("Function "+b+"() already exposed");if(l._firstMessageReceived)throw new Error("Too late to expose function, worker in use");l._exposed[b]=a},l._exposed={},l._firstMessageReceived=!1,self.window=self,f(),l});
//# sourceMappingURL=worker.umd.min.js.map